/*! For license information please see 621.aae5f0a57e6e809e7947.js.LICENSE.txt */
(self.webpackChunkipydingo=self.webpackChunkipydingo||[]).push([[621],{621:e=>{var t;self,t=function(){return(()=>{"use strict";var e={"./src/canvas-video-session.js":(e,t,i)=>{i.r(t),i.d(t,{CanvasVideoSession:()=>m});var s=i("./src/video-session.js");function n(e,t,i,s){let n=function(e,t,i,s){let n=s/t,o=i/e;return n<o?[n*e,n*t]:[o*e,o*t]}(e,t,i,s),o=(i-n[0])/2,r=(s-n[1])/2;return[o,r,o+n[0],r+n[1]]}class o{constructor(){this.active=!1}getSelectionRect(){if(this.box)return this.box}start(e){this.active=!0,this.origin=e,this.box=[e[0],e[1],e[0],e[1]]}update(e){this.box=function(e,t){let i={};return e[0]<t[0]?(i.left=e[0],i.right=t[0]):(i.left=t[0],i.right=e[0]),e[1]<t[1]?(i.top=e[1],i.bottom=t[1]):(i.top=t[1],i.bottom=e[1]),i=[i.left,i.top,i.right,i.bottom],i}(this.origin,e)}stop(e){this.active=!1}}function r(e){this.tool=new o}function a(e){switch(e.code){case"ShiftLeft":r.call(this,e)}e.stopPropagation()}function l(e){this.setImageMaximized()}function c(e){if(this.tool&&this.tool.getSelectionRect()){let e=this.canvas.getContext("2d");e.clearRect(0,0,e.canvas.width,e.canvas.height),this.imageSelection().then((e=>{let t=n(e[2]-e[0],e[3]-e[1],this.vid.videoWidth,this.vid.videoHeight),i=(e[2]-e[0])/(t[2]-t[0]),s=(e[3]-e[1])/(t[3]-t[1]),o=[e[0]+Math.round((this.tool.box[0]-t[0])*i),e[1]+Math.round((this.tool.box[1]-t[1])*s),e[0]+Math.round((this.tool.box[2]-t[0])*i),e[1]+Math.round((this.tool.box[3]-t[1])*s)];this.setImageSelection(o),this.tool=null}))}}function h(e){switch(e.code){case"Escape":l.call(this,e);break;case"ShiftLeft":c.call(this,e)}e.stopPropagation()}function d(e){if(this.tool){let t=e.target.getBoundingClientRect(),i=e.clientX-t.left,s=e.clientY-t.top;this.tool.start([i,s]);let n=e.target.getContext("2d");n.drawImage(this.vid,0,0,this.canvas.width,this.canvas.height),n.save(),n.fillStyle=this.selectionStyle,n.globalAlpha=this.selectionAlpha,n.fillRect(this.tool.box[0],this.tool.box[1],this.tool.box[2]-this.tool.box[0],this.tool.box[3]-this.tool.box[1]),n.restore()}}function u(e){if(this.tool&&this.tool.active){let t=e.target.getBoundingClientRect(),i=e.clientX-t.left,s=e.clientY-t.top,o=n(this.imageSelectionBox[2]-this.imageSelectionBox[0],this.imageSelectionBox[3]-this.imageSelectionBox[1],this.vid.videoWidth,this.vid.videoHeight);if(i>=o[0]&&s>=o[1]&&i<o[2]&&s<=o[3]){this.tool.update([i,s]);let t=e.target.getContext("2d");t.drawImage(this.vid,0,0,this.canvas.width,this.canvas.height),t.strokeStyle=this.selectionStyle,t.strokeRect(this.tool.box[0],this.tool.box[1],this.tool.box[2]-this.tool.box[0],this.tool.box[3]-this.tool.box[1])}}}function v(e){this.tool&&this.tool.stop([])}function g(e){this.canvas.width!=this.vid.videoWidth&&(this.canvas.width=this.vid.videoWidth),this.canvas.height!=this.vid.videoHeight&&(this.canvas.height=this.vid.videoHeight);let t=this.canvas.getContext("2d");t.drawImage(this.vid,0,0,this.canvas.width,this.canvas.height),this.tool&&this.tool.getSelectionRect()&&(t.save(),t.fillStyle=this.selectionStyle,t.globalAlpha=this.selectionAlpha,t.fillRect(this.tool.box[0],this.tool.box[1],this.tool.box[2]-this.tool.box[0],this.tool.box[3]-this.tool.box[1]),t.restore()),this.animationRequestID=requestAnimationFrame(g.bind(this))}class m{constructor(e){this.selectionStyle="#A1A0D7",this.selectionAlpha=.2,this.underlying=new s.VideoSession,this.conn=e,this.conn.addEventListener("state",(e=>{let t=e.detail.detail;this.imageSelectionBox=t.camera.selection})),this.domElement=document.createElement("canvas"),this.domElement.onselectstart=function(){return!1};let t=this.domElement.getContext("2d");t.save(),t.fillStyle="black",t.fillRect(0,0,this.canvas.width,this.canvas.height),t.restore(),this.canvas.addEventListener("mousedown",d.bind(this)),this.canvas.addEventListener("mousemove",u.bind(this)),this.canvas.addEventListener("mouseup",v.bind(this)),window.addEventListener("keydown",a.bind(this)),window.addEventListener("keyup",h.bind(this)),this.animationRequestID=requestAnimationFrame(g.bind(this))}decode(e){this.underlying.decode(e)}get canvas(){return this.domElement}get vid(){return this.underlying.domElement}call(e,...t){return new Promise(((i,s)=>{this.conn.call(((e,t)=>{e?s(e):i(t)}),e,...t)}))}imageSelection(){return this.call("image_selection")}setImageMaximized(){return this.call("imageMaximize")}setImageSelection(e){return new Promise(((t,i)=>{this.conn.call(t,"set_image_selection",e)}))}}},"./src/client-connection.js":(e,t,i)=>{i.r(t),i.d(t,{ClientConnection:()=>r});var s=i("./src/event-target.js");function n(e){this.dispatchEvent(new Event("connect",{bubbles:!0}))}function o(e){e.data instanceof Blob||e.data instanceof ArrayBuffer?this.onbinary(e.data):this.onjson(JSON.parse(e.data))}class r extends s.EventTarget{constructor(e,t,i){super(i),this.addr=e,this.port=t,this.map=new Map,this.underlying=new WebSocket(`ws://${this.addr}:${this.port}`),this.underlying.binaryType="arraybuffer",this.underlying.addEventListener("open",n.bind(this)),this.underlying.addEventListener("message",o.bind(this))}onjson(e){if(this.currentObject=e,"remote-call"==this.currentObject.type){let e=this.currentObject.detail,t=this.map.get(e.id);e.error?t(e.error.message,null):t(null,e.result),this.map.delete(e.id)}else this.dispatchEvent(new CustomEvent(this.currentObject.type,{bubbles:!0,detail:{detail:this.currentObject.detail,buffers:[]}}))}onbinary(e){this.videoSession&&this.videoSession.decode(e)}get isConnected(){return this.underlying.readyState==WebSocket.OPEN}call(e,t,...i){let s=r.newID(),n=JSON.stringify({type:"remote-call",detail:{method:t,params:i,id:s}});this.map.set(s,e),this.underlying.send(n)}close(){this.underlying.close()}static newID(){let e=r.nextId;return++r.nextId,e}}r.nextId=0},"./src/client.js":(e,t,i)=>{i.r(t),i.d(t,{Client:()=>a,videoConnectionFactory:()=>l});var s=i("./src/client-connection.js"),n=i("./src/video-session.js"),o=i("./src/canvas-video-session.js"),r=i("./src/event-target.js");class a extends r.EventTarget{constructor(){super(),this.videoConnections=[]}connect(e,t){this.stub=new s.ClientConnection(e,t,this.target)}capture(e){this.stub.call(e,"capture")}plugins(){return this.call("plugins")}touch(){return this.call("touch")}brightness(){return this.call("brightness")}brightnessRange(){return this.call("brightness_range")}exposure(){return this.call("exposure")}exposureRange(){return this.call("exposure_range")}process(){return this.call("process")}cancel(){return this.call("cancel")}call(e,...t){return new Promise(((i,s)=>{this.stub.call(((e,t)=>{e?s(e):i(t)}),e,...t)}))}imageSelection(){return this.call("image_selection")}imageSizeMax(){return this.call("image_size_max")}shownPluginLabels(){return this.call("shown_plugin_labels")}videoLabels(){return this.call("video_labels")}videoNormalized(){return this.call("is_video_normalized")}videoShow(){return this.call("video_show")}videoZ(){return this.call("video_z")}resetBackground(){return this.call("resetBackground")}saveImage(){return this.call("save_image")}saveImageBackground(){return this.call("save_image_background")}saveSettings(){return this.call("save_settings")}setBrightness(e){return this.call("set_brightness",e)}imageMaximize(){return this.call("imageMaximize")}setImageSelection(e){return new Promise(((t,i)=>{this.stub.call(t,"set_image_selection",e)}))}setShowPlugin(e){return this.call("show_plugin",e)}setShowPluginLabels(e){return this.call("show_plugin_labels",e)}setBackgroundPolicy(e){this.call("setBackgroundPolicy",e)}setCameraExposure(e){this.call("set_camera_exposure",e)}setCameraLeft(e){return this.call("setCameraLeft",e)}setCameraTop(e){return this.call("setCameraTop",e)}setCameraRight(e){return this.call("setCameraRight",e)}setCameraBottom(e){return this.call("setCameraBottom",e)}setRenderRemoveBackground(e){this.call("set_render_remove_background",e)}setRenderWhich(e){this.call("set_render_which",e)}setRenderZ(e){this.call("setRenderZ",e)}setVideoResolution(e){this.call("setVideoResolution",e)}record(e,t,i){this.call("record",s.ClientConnection.newID(),e,t,i)}video(e=l){let t=e(this.stub.addr,this.stub.port);return this.videoConnections.push(t),t.videoSession.domElement}videoRemoveReference(){return this.call("video_remove_reference")}videoUnwrapPhase(){return this.call("video_unwrap_phase")}}function l(e,t,i="canvas"){let r=new s.ClientConnection(e,t);if("video"==i)r.videoSession=new n.VideoSession;else{if("canvas"!=i)throw"Unsupported video tag";window.safari?(console.warn("drawing a video onto a canvas is unsupported in Safari, returning a video instead"),r.videoSession=new n.VideoSession):r.videoSession=new o.CanvasVideoSession(r)}return r.addEventListener("connect",(()=>{r.call((()=>{}),"video",s.ClientConnection.newID())})),r}},"./src/event-target.js":(e,t,i)=>{i.r(t),i.d(t,{EventTarget:()=>s});class s{constructor(e){this.target=document.createElement("div"),e&&e.appendChild(this.target)}addEventListener(...e){this.target.addEventListener(...e)}dispatchEvent(...e){this.target.dispatchEvent(...e)}}},"./src/video-session.js":(e,t,i)=>{i.r(t),i.d(t,{VideoSession:()=>l}),i("./src/client-connection.js");var s=i("./src/event-target.js");function n(e){let t=e.target;this.queue.length>0&&!t.updating&&t.appendBuffer(this.queue.shift())}function o(e){this.srcBuffer=this.srcObject.addSourceBuffer('video/mp4; codecs="avc1.42E01E"'),this.srcBuffer.addEventListener("updateend",n.bind(this)),this.queue.length>0&&this.srcBuffer.appendBuffer(this.queue.shift())}function r(e){}function a(e){delete this.srcBuffer}class l extends s.EventTarget{constructor(){super(),this.queue=[],this.srcObject=new MediaSource,console.dir(this.srcObject),this.srcObject.addEventListener("sourceopen",o.bind(this)),this.srcObject.addEventListener("sourceclose",a.bind(this)),this.srcObject.addEventListener("sourceended",r.bind(this)),this.src=window.URL.createObjectURL(this.srcObject),this.domElement=document.createElement("video"),this.domElement.autoplay=!0,this.domElement.muted=!0,this.domElement.preload="metadata",this.domElement.src=this.src,this.domElement.addEventListener("progress",c)}decode(e){!this.srcBuffer||this.srcBuffer.updating||this.queue.length>0?this.queue.push(e):this.srcBuffer.appendBuffer(e)}}function c(e){let t=e.target;if(t.seekable.length>0){let e=t.seekable.end(t.seekable.length-1);t.currentTime=e-1e-6}}}},t={};function i(s){var n=t[s];if(void 0!==n)return n.exports;var o=t[s]={exports:{}};return e[s](o,o.exports,i),o.exports}i.d=(e,t)=>{for(var s in t)i.o(t,s)&&!i.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var s={};return(()=>{i.r(s),i.d(s,{CanvasVideoSession:()=>e.CanvasVideoSession,Client:()=>t.Client,videoConnectionFactory:()=>t.videoConnectionFactory,VideoSession:()=>n.VideoSession});var e=i("./src/canvas-video-session.js"),t=i("./src/client.js"),n=i("./src/video-session.js")})(),s})()},e.exports=t()}}]);