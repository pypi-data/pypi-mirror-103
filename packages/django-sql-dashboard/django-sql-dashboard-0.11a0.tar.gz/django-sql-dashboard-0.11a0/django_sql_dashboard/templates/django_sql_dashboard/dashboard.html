{% extends "django_sql_dashboard/base.html" %}
{% load django_sql_dashboard %}

{% block title %}{{ html_title }}{% endblock %}

{% block content %}
<h1>{{ title }}</h1>
{% if saved_dashboard %}
  <p>{{ description }}</p>
{% endif %}

{% if too_long_so_used_post %}
  <p style="background-color: pink; padding: 0.5em 1em 1em 1em; border: 2px solid red; margin-bottom: 1em">
    This SQL is too long to bookmark, so sharing a link to this page will not work for these queries.
  </p>
{% endif %}

{% if unverified_sql_queries %}
  <div style="background-color: pink; padding: 0.5em 1em 1em 1em; border: 2px solid red; margin-bottom: 1em">
    <h2 style="margin-top: 0.5em">Unverified SQL</h2>
    <p>The link you followed here included SQL that was missing its verification signatures.</p>
    <p>If this link was provided to you by an untrusted source, they may be trying to trick you into executing queries that you do not want to execute.</p>
    <p>Review these queries and copy and paste them once you have confirmed them:</p>
    {% for query in unverified_sql_queries %}
      <p><textarea>{{ query }}</textarea></p>
    {% endfor %}
  </div>
{% endif %}
<form action="{{ request.path }}" method="{% if saved_dashboard %}GET{% else %}POST{% endif %}">
  {% if not saved_dashboard %}{% csrf_token %}{% endif %}
  {% if parameter_values %}
    <h3>Query parameters</h3>
    <div class="query-parameters">
    {% for name, value in parameter_values %}
        <label for="qp{{ forloop.counter }}">{{ name }}</label>
        <input type="text" id="qp{{ forloop.counter }}" name="{{ name }}" value="{{ value }}">
    {% endfor %}
    </div>
    <input
      class="btn"
      type="submit"
      value="Run quer{% if query_results|length > 1 %}ies{% else %}y{% endif %}"
    />
  {% endif %}
  {% for result in query_results %}
    {% include result.templates with result=result %}
  {% endfor %}
  {% if not saved_dashboard %}
    <p>Add another query:</p>

    <textarea
      style="
        width: 60%;
        height: 10em;
        border: 2px solid #666;
        padding: 0.5em;
      "
      name="sql"
    ></textarea>

    <p>
      <input
        class="btn"
        type="submit"
        value="Run quer{% if query_results|length > 1 %}ies{% else %}y{% endif %}"
      />
    </p>
  {% endif %}
</form>

{% if not saved_dashboard %}
  <h2>Available tables</h2>
  <ul style="column-count: 2">
    {% for table in available_tables %}
      <li><a href="?sql={% filter sign_sql|urlencode %}select count(*) from {{ table }}{% endfilter %}&sql={% filter sign_sql|urlencode %}select * from {{ table }}{% endfilter %}">{{ table }}</a></li>
    {% endfor %}
{% endif %}

<script>
var svgCopyIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>`;

Array.from(document.querySelectorAll("pre.json")).forEach((pre) => {
  var svg = document.createElement("div");
  svg.innerHTML = svgCopyIcon;
  svg = svg.querySelector("*");
  pre.style.position = 'relative';
  svg.style.position = 'absolute';
  svg.style.top = 0;
  svg.style.right = 0;
  svg.style.width = '14px';
  svg.style.cursor = 'pointer';
  svg.addEventListener('click', function() {
    var input = document.createElement('input');
    input.setAttribute('type', 'text');
    input.style.position = 'absolute';
    input.style.opacity = 0;
    // Everything up to the last ] or }, to avoid broken
    // JSON if the 'copied' text is still present
    var json = pre.innerText.match(/^(.*[\]\}].*?$)$/gms)[0]
    input.value = JSON.stringify(JSON.parse(json));
    pre.appendChild(input);
    input.select();
    document.execCommand("copy");
    input.parentNode.removeChild(input);
    // Show a 'copied' message then fade it out
    var copied = document.createElement('span');
    copied.innerHTML = 'Copied';
    copied.style.position = 'absolute';
    copied.style.top = '3ex';
    copied.style.right = 0;
    copied.style.color = '#666';
    copied.style.fontFamily = 'Helvetica, sans-serif';
    copied.style.fontSize = '0.8em';
    copied.style.fontWeight = 'bold';
    copied.style.transition = 'opacity 1s';
    pre.appendChild(copied);
    setTimeout(() => {
      copied.parentNode.removeChild(copied);
    }, 1500);
    setTimeout(() => {
      copied.style.opacity = 0;
    }, 500);
  });
  pre.appendChild(svg);
});
</script>

{% endblock %}
