
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>bci_framework.framework.subprocess_handler &#8212; BCI-Framework  documentation</title>
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="shortcut icon" href="../../../_static/favico.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for bci_framework.framework.subprocess_handler</h1><div class="highlight"><pre>
<span></span>&quot;&quot;&quot;
==================
Subprocess handler
==================
&quot;&quot;&quot;

import os
import sys
import socket
import logging
import subprocess
from queue import Queue, Empty
from urllib import request
from contextlib import closing
from typing import TypeVar, Optional

from PySide2.QtCore import QTimer, QSize
from PySide2.QtWebEngineWidgets import QWebEngineView, QWebEnginePage

from .nbstreamreader import NonBlockingStreamReader as NBSR
from ..extensions import properties as prop


COMMAND = TypeVar(&#39;Command&#39;)
PATH = TypeVar(&#39;Path&#39;)


# ----------------------------------------------------------------------
<div class="viewcode-block" id="run_subprocess"><a class="viewcode-back" href="../../bci_framework.framework.subprocess_handler.html#bci_framework.framework.subprocess_handler.run_subprocess">[docs]</a>def run_subprocess(call: COMMAND) -&gt; subprocess.Popen:
    &quot;&quot;&quot;Run a python script with non blocking debugger installed.&quot;&quot;&quot;
    my_env = os.environ.copy()
    my_env[&#39;PYTHONPATH&#39;] = &quot;:&quot;.join(
        sys.path + [os.path.join(os.path.dirname(sys.argv[0]))])

    sub = subprocess.Popen(call,
                           stdout=subprocess.PIPE,
                           stderr=subprocess.STDOUT,
                           env=my_env,
                           preexec_fn=os.setsid,
                           shell=False,
                           # universal_newlines=True,
                           # bufsize=1,
                           )
    sub.nb_stdout = NBSR(sub.stdout)

    return sub</div>


########################################################################
<div class="viewcode-block" id="BrythonLogging"><a class="viewcode-back" href="../../bci_framework.framework.subprocess_handler.html#bci_framework.framework.subprocess_handler.BrythonLogging">[docs]</a>class BrythonLogging:
    &quot;&quot;&quot;Log messages from Brython.&quot;&quot;&quot;

    # ----------------------------------------------------------------------
    def __init__(self):
        &quot;&quot;&quot;&quot;&quot;&quot;
        self.message = Queue()

    # ----------------------------------------------------------------------
<div class="viewcode-block" id="BrythonLogging.feed"><a class="viewcode-back" href="../../bci_framework.framework.subprocess_handler.html#bci_framework.framework.subprocess_handler.BrythonLogging.feed">[docs]</a>    def feed(self, level: int, message: str, lineNumber: int, sourceID: str) -&gt; None:
        &quot;&quot;&quot;Concatenae messages.&quot;&quot;&quot;
        self.message.put(message)</div>

    # ----------------------------------------------------------------------
<div class="viewcode-block" id="BrythonLogging.readline"><a class="viewcode-back" href="../../bci_framework.framework.subprocess_handler.html#bci_framework.framework.subprocess_handler.BrythonLogging.readline">[docs]</a>    def readline(self, timeout: Optional[int] = None) -&gt; str:
        &quot;&quot;&quot;Get mesage from JavaScriptConsole.&quot;&quot;&quot;
        if self.message.qsize():
            try:
                return self.message.get(block=timeout is not None, timeout=timeout)
            except Empty:
                return None</div></div>


########################################################################
<div class="viewcode-block" id="VisualizationSubprocess"><a class="viewcode-back" href="../../bci_framework.framework.subprocess_handler.html#bci_framework.framework.subprocess_handler.VisualizationSubprocess">[docs]</a>class VisualizationSubprocess:
    &quot;&quot;&quot;Define matplotlib properties and start the auto-resizer.&quot;&quot;&quot;

    # ----------------------------------------------------------------------
    def viz_auto_size(self, timer: bool = True) -&gt; None:
        &quot;&quot;&quot;&quot;&quot;&quot;
        if self.stopped:
            return

        dpi = prop.DPI
        f = dpi / self.main.DPI
        try:
            size = self.main.web_engine.size()
            if self.plot_size != size or self.plot_dpi != self.main.DPI:
                if &#39;light&#39; in os.environ.get(&#39;QTMATERIAL_THEME&#39;):
                    background = &#39;ffffff&#39;
                else:
                    background = &#39;000000&#39;

                self.main.web_engine.setUrl(
                    self.url + f&#39;/?width={f * size.width() / dpi:.2f}&amp;height={f * size.height() / dpi:.2f}&amp;dpi={dpi/f:.2f}&amp;background={background}&#39;)
                self.plot_dpi = self.main.DPI
                self.plot_size = size
        except:
            pass

        if timer:
            self.timer.singleShot(1000, self.viz_auto_size)

    # ----------------------------------------------------------------------
    def viz_debug(self) -&gt; None:
        &quot;&quot;&quot;&quot;&quot;&quot;
        self.stdout = self.subprocess_script.nb_stdout

    # ----------------------------------------------------------------------
    def viz_start(self) -&gt; None:
        &quot;&quot;&quot;&quot;&quot;&quot;
        self.timer.singleShot(1000, self.viz_auto_size)</div>


########################################################################
<div class="viewcode-block" id="StimuliSubprocess"><a class="viewcode-back" href="../../bci_framework.framework.subprocess_handler.html#bci_framework.framework.subprocess_handler.StimuliSubprocess">[docs]</a>class StimuliSubprocess:
    &quot;&quot;&quot;Connect with Brython logs.&quot;&quot;&quot;

    # ----------------------------------------------------------------------
    def stm_debug(self) -&gt; None:
        &quot;&quot;&quot;&quot;&quot;&quot;
        console = BrythonLogging()
        self.web_engine_page = QWebEnginePage(self.main.web_engine)
        self.web_engine_page.javaScriptConsoleMessage = console.feed
        self.main.web_engine.setPage(self.web_engine_page)
        self.stdout = console
        self.web_engine_page .profile().clearHttpCache()
        self.stm_start()

    # ----------------------------------------------------------------------
    def stm_start(self) -&gt; None:
        &quot;&quot;&quot;&quot;&quot;&quot;
        self.main.web_engine.setUrl(self.url)</div>


########################################################################
class LoadSubprocess(VisualizationSubprocess, StimuliSubprocess):
    &quot;&quot;&quot;&quot;&quot;&quot;

    # ----------------------------------------------------------------------
    def __init__(self, parent, path: Optional[PATH] = None, use_webview: Optional[bool] = True, debugger: Optional[bool] = False):
        &quot;&quot;&quot;&quot;&quot;&quot;
        self.main = parent
        self.web_view = self.main.gridLayout_webview
        self.plot_size = QSize(0, 0)
        self.plot_dpi = 0
        self.stopped = False
        # self.is_analysis = not use_webview
        # self.is_visualization = use_webview
        # self.is_stimuli = use_webview
        self.debugger = debugger

        if path:
            self.load_path(path)

    # ----------------------------------------------------------------------
    def load_path(self, path: PATH) -&gt; None:
        &quot;&quot;&quot;Load Python scipt.&quot;&quot;&quot;
        self.timer = QTimer()

        self.is_analysis = self.file_is_analysis(path)

        if not self.is_analysis:
            self.port = self.get_free_port()
        else:
            self.port = &#39;&#39;
        self.subprocess_script = run_subprocess(
            [sys.executable, path, self.port])

        if self.is_analysis:
            self.is_visualization = False
            self.is_stimuli = False
            pass
            # self.start_debug()
        else:
            self.prepare_webview()

    # ----------------------------------------------------------------------
    def file_is_analysis(self, path):
        &quot;&quot;&quot;&quot;&quot;&quot;
        with open(path, &#39;r&#39;) as file:
            return &#39;data_analysis import DataAnalysis&#39; in file.read()

    # ----------------------------------------------------------------------
    def prepare_webview(self) -&gt; None:
        &quot;&quot;&quot;Try to load the webview.&quot;&quot;&quot;
        # Try to get mode
        try:
            self.mode = request.urlopen(
                f&#39;http://localhost:{self.port}/mode&#39;, timeout=10).read().decode()
        except:  # if fail
            self.timer.singleShot(100, self.prepare_webview)  # call again
            return

        # and only when the mode is explicit...

        if self.mode == &#39;visualization&#39;:
            self.is_visualization = True
            self.is_stimuli = False
            self.is_analysis = False
            endpoint = &#39;&#39;
        elif self.mode == &#39;stimuli&#39;:
            self.is_visualization = False
            self.is_stimuli = True
            self.is_analysis = False
            endpoint = &#39;dashboard&#39;

        # self.main.widget_development_webview.show()
        self.url = f&#39;http://localhost:{self.port}/{endpoint}&#39;
        self.load_webview()

    # ----------------------------------------------------------------------
    def stop_preview(self) -&gt; None:
        &quot;&quot;&quot;Kill the subprocess and crear the webview.&quot;&quot;&quot;
        self.timer.stop()
        self.stopped = True
        if hasattr(self, &#39;subprocess_script&#39;):
            self.subprocess_script.nb_stdout.stop()
            self.subprocess_script.terminate()
            if hasattr(self, &#39;subprocess_script&#39;):
                self.timer.singleShot(
                    300, lambda: self.__delattr__(&#39;subprocess_script&#39;))

        if hasattr(self, &#39;web_engine_page&#39;):
            try:
                self.web_engine_page.deleteLater()
            except:  # already deleted.
                pass

        # TODO: A wait page could be a god idea
        self.main.widget_development_webview.hide()
        if hasattr(self.main, &#39;web_engine&#39;):
            self.main.web_engine.setUrl(&#39;about:blank&#39;)

    # ----------------------------------------------------------------------
    def load_webview(self) -&gt; None:
        &quot;&quot;&quot;After the process starting, set the URL into the webview.&quot;&quot;&quot;
        self.main.widget_development_webview.show()

        # Create main QWebEngineView object
        if not hasattr(self.main, &#39;web_engine&#39;):
            self.main.web_engine = QWebEngineView()
            self.web_view.addWidget(self.main.web_engine)

        else:
            # self.main.web_engine.deleteLater()
            # self.main.web_engine = QWebEngineView()
            self.web_view.addWidget(self.main.web_engine)

        # Set URL and start interface
        if self.is_visualization:
            self.viz_start()
        elif self.is_stimuli:
            self.stm_start()

    # ----------------------------------------------------------------------
    def start_debug(self) -&gt; None:
        &quot;&quot;&quot;Try to start the debugger.&quot;&quot;&quot;
        if self.debugger:
            try:
                if self.is_stimuli:
                    self.stm_debug()
                elif self.is_visualization or self.is_analysis:
                    self.viz_debug()
            except Exception as e:
                pass

    # ----------------------------------------------------------------------
    def reload(self) -&gt; None:
        &quot;&quot;&quot;Restart the webview.&quot;&quot;&quot;
        self.main.web_engine.setUrl(self.url)

    # ----------------------------------------------------------------------
    def get_free_port(self) -&gt; str:
        &quot;&quot;&quot;Get any free port available.&quot;&quot;&quot;
        with closing(socket.socket(socket.AF_INET, socket.SOCK_STREAM)) as s:
            s.bind((&#39;&#39;, 0))
            s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
            port = str(s.getsockname()[1])
            logging.info(f&#39;Free port found in {port}&#39;)
            return port


</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/logo.svg" alt="Logo"/>
            </a></p><h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/00-installation.html">Installation and running</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/01-configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/02-interface.html">Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/70-data_analysis.html">Data analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/75-data_visualizations.html">Data visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/76-default_visualizations.html">Examples of data visualizations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/80-stimuli_delivery.html">Stimuli delivery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/81-default_stimuli_delivery_paradigms.html">Examples of stimuli delivery paradigms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/90-event_marker_synchronization.html">Event marker synchronization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/91-eeg_records_exploring.html">EEG records exploring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/99-ilustrative_example.html">Illustrative example</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, Yeison Cardona.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.5.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>