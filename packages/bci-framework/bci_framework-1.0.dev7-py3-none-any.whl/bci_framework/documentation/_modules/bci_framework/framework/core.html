
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>bci_framework.framework.core &#8212; BCI-Framework  documentation</title>
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="shortcut icon" href="../../../_static/favico.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for bci_framework.framework.core</h1><div class="highlight"><pre>
<span></span>&quot;&quot;&quot;
====
Core
====
&quot;&quot;&quot;

import os
import json
import psutil
import pickle
from datetime import datetime
from typing import TypeVar, Optional

from PySide2.QtUiTools import QUiLoader
from PySide2.QtCore import Qt, QTimer, QSize, Signal, QThread, Slot
from PySide2.QtGui import QPixmap, QIcon, QFontDatabase, QKeySequence
from PySide2.QtWidgets import QDesktopWidget, QMainWindow, QDialogButtonBox, QPushButton, QLabel, QShortcut

from kafka import KafkaProducer, KafkaConsumer

from .widgets import Montage, Projects, Connection, Records, Annotations
from .environments import Development, Visualization, StimuliDelivery
from .config_manager import ConfigManager
from .configuration import ConfigurationFrame
from ..extensions import properties as prop

import numpy as np

KAFKA_STREAM = TypeVar(&#39;Kafka&#39;)


########################################################################
<div class="viewcode-block" id="Kafka"><a class="viewcode-back" href="../../bci_framework.framework.core.html#bci_framework.framework.core.Kafka">[docs]</a>class Kafka(QThread):
    &quot;&quot;&quot;Kafka run on a thread.&quot;&quot;&quot;
    over = Signal(object)
    message = Signal()
    produser_connected = Signal()
    continue_ = True

    # ----------------------------------------------------------------------
<div class="viewcode-block" id="Kafka.set_host"><a class="viewcode-back" href="../../bci_framework.framework.core.html#bci_framework.framework.core.Kafka.set_host">[docs]</a>    def set_host(self, host: str) -&gt; None:
        &quot;&quot;&quot;Set the host for kafka.&quot;&quot;&quot;
        self.host = host</div>

    # ----------------------------------------------------------------------
<div class="viewcode-block" id="Kafka.stop"><a class="viewcode-back" href="../../bci_framework.framework.core.html#bci_framework.framework.core.Kafka.stop">[docs]</a>    def stop(self) -&gt; None:
        &quot;&quot;&quot;Kill the thread.&quot;&quot;&quot;
        self.continue_ = False
        self.terminate()</div>

    # ----------------------------------------------------------------------
<div class="viewcode-block" id="Kafka.run"><a class="viewcode-back" href="../../bci_framework.framework.core.html#bci_framework.framework.core.Kafka.run">[docs]</a>    def run(self) -&gt; None:
        &quot;&quot;&quot;Start the produser and consumer for Kafka.&quot;&quot;&quot;
        try:
            self.create_produser()
            self.produser_connected.emit()
            self.create_consumer()
        except Exception as e:
            self.message.emit()
            self.stop()</div>

    # ----------------------------------------------------------------------
<div class="viewcode-block" id="Kafka.create_consumer"><a class="viewcode-back" href="../../bci_framework.framework.core.html#bci_framework.framework.core.Kafka.create_consumer">[docs]</a>    def create_consumer(self) -&gt; None:
        &quot;&quot;&quot;Basic consumer to check stream status and availability.&quot;&quot;&quot;
        bootstrap_servers = [f&#39;{self.host}:9092&#39;]
        topics = [&#39;annotation&#39;, &#39;marker&#39;, &#39;command&#39;, &#39;eeg&#39;, &#39;feedback&#39;]
        self.consumer = KafkaConsumer(bootstrap_servers=bootstrap_servers,
                                      value_deserializer=pickle.loads,
                                      auto_offset_reset=&#39;latest&#39;,
                                      )

        self.consumer.subscribe(topics)

        for message in self.consumer:
            self.last_message = datetime.now()
            message.value[&#39;timestamp&#39;] = message.timestamp / 1000
            self.over.emit({&#39;topic&#39;: message.topic, &#39;value&#39;: message.value})

            if not self.continue_:
                return</div>

    # ----------------------------------------------------------------------
<div class="viewcode-block" id="Kafka.create_produser"><a class="viewcode-back" href="../../bci_framework.framework.core.html#bci_framework.framework.core.Kafka.create_produser">[docs]</a>    def create_produser(self) -&gt; None:
        &quot;&quot;&quot;The produser is used for stream annotations and markers.&quot;&quot;&quot;
        self.produser = KafkaProducer(bootstrap_servers=[f&#39;{self.host}:9092&#39;],
                                      compression_type=&#39;gzip&#39;,
                                      value_serializer=pickle.dumps,
                                      )</div></div>


########################################################################
class BCIFramework(QMainWindow):
    &quot;&quot;&quot;&quot;&quot;&quot;

    # ----------------------------------------------------------------------
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)

        self.load_fonts()
        self.main = QUiLoader().load(os.path.join(os.path.abspath(os.path.dirname(__file__)),
                                                  &#39;qtgui&#39;, &#39;main.ui&#39;))
        self.set_icons()

        self.main.setCorner(Qt.BottomLeftCorner, Qt.LeftDockWidgetArea)
        self.main.setCorner(Qt.BottomRightCorner, Qt.RightDockWidgetArea)

        self.main.actionDevelopment.triggered.connect(
            lambda evt: self.show_interface(&#39;Development&#39;))
        self.main.actionVisualizations.triggered.connect(
            lambda evt: self.show_interface(&#39;Visualizations&#39;))
        self.main.actionStimuli_delivery.triggered.connect(
            lambda evt: self.show_interface(&#39;Stimuli_delivery&#39;))
        self.main.actionHome.triggered.connect(
            lambda evt: self.show_interface(&#39;Home&#39;))
        self.main.actionDocumentation.triggered.connect(
            lambda evt: self.show_interface(&#39;Documentation&#39;))

        shortcut_fullscreen = QShortcut(QKeySequence(&#39;F11&#39;), self.main)
        shortcut_fullscreen.activated.connect(lambda: self.main.showMaximized(
        ) if self.main.windowState() &amp; Qt.WindowFullScreen else self.main.showFullScreen())

        shortcut_docs = QShortcut(QKeySequence(&#39;F1&#39;), self.main)
        shortcut_docs.activated.connect(
            lambda: self.show_interface(&#39;Documentation&#39;))

        shortcut_docs = QShortcut(QKeySequence(&#39;F2&#39;), self.main)
        shortcut_docs.activated.connect(self.toggle_dock_collapsed)

        self.show_interface(&#39;Home&#39;)
        self.config = ConfigManager()

        for i in range(self.main.toolBar_environs.layout().count()):
            tool_button = self.main.toolBar_environs.layout().itemAt(i).widget()
            tool_button.setMaximumWidth(200)
            tool_button.setMinimumWidth(200)

        self.set_editor()
        self.build_collapse_button()

        self.montage = Montage(self)
        self.connection = Connection(self)
        self.projects = Projects(self.main, self)
        self.records = Records(self.main, self)
        self.annotations = Annotations(self.main, self)

        self.development = Development(self)
        self.visualizations = Visualization(self)
        self.stimuli_delivery = StimuliDelivery(self)

        # self.status_bar(&#39;OpenBCI no connected&#39;)

        self.main.tabWidget_widgets.setCurrentIndex(0)
        self.main.tabWidget_data_analysis.setCurrentIndex(0)
        self.style_home_page()

        self.connect()

        docs = os.path.abspath(os.path.join(os.environ.get(
            &#39;BCISTREAM_ROOT&#39;), &#39;documentation&#39;, &#39;index.html&#39;))
        self.main.webEngineView_documentation.setUrl(f&#39;file://{docs}&#39;)

        self.subprocess_timer = QTimer()
        self.subprocess_timer.timeout.connect(self.save_subprocess)
        self.subprocess_timer.setInterval(5000)
        self.subprocess_timer.start()

        self.status_bar(message=&#39;&#39;, right_message=(&#39;disconnected&#39;, None))

    # ----------------------------------------------------------------------
    def set_icons(self) -&gt; None:
        &quot;&quot;&quot;The Qt resource system has been deprecated.&quot;&quot;&quot;
        def icon(name):
            return QIcon(f&quot;bci:/primary/{name}.svg&quot;)

        self.main.actionDevelopment.setIcon(icon(&quot;file&quot;))
        self.main.actionVisualizations.setIcon(icon(&quot;brain&quot;))
        self.main.actionStimuli_delivery.setIcon(icon(&quot;imagery&quot;))
        self.main.actionHome.setIcon(icon(&quot;home&quot;))
        self.main.actionDocumentation.setIcon(icon(&quot;documentation&quot;))

        self.main.pushButton_file.setIcon(icon(&quot;file&quot;))
        self.main.pushButton_brain.setIcon(icon(&quot;brain&quot;))
        self.main.pushButton_imagery.setIcon(icon(&quot;imagery&quot;))
        self.main.pushButton_docs.setIcon(icon(&quot;documentation&quot;))
        self.main.pushButton_latency.setIcon(icon(&quot;latency2&quot;))
        self.main.pushButton_annotations.setIcon(icon(&quot;annotation&quot;))

        self.main.pushButton_stop_preview.setIcon(icon(&#39;media-playback-stop&#39;))
        self.main.pushButton_script_preview.setIcon(
            icon(&#39;media-playback-start&#39;))
        self.main.pushButton_play_signal.setIcon(icon(&#39;media-playback-start&#39;))
        self.main.pushButton_clear_debug.setIcon(icon(&#39;edit-delete&#39;))
        self.main.pushButton_record.setIcon(icon(&#39;media-record&#39;))

        self.main.pushButton_projects_add_file.setIcon(icon(&#39;document-new&#39;))
        self.main.pushButton_projects_add_folder.setIcon(icon(&#39;folder-add&#39;))
        self.main.pushButton_add_project.setIcon(icon(&#39;folder-add&#39;))
        self.main.pushButton_projects_remove.setIcon(icon(&#39;edit-delete&#39;))
        self.main.pushButton_remove_project.setIcon(icon(&#39;edit-delete&#39;))
        self.main.pushButton_remove_montage.setIcon(icon(&#39;edit-delete&#39;))

        self.main.pushButton_projects.setIcon(icon(&#39;go-up&#39;))
        self.main.pushButton_load_visualizarion.setIcon(icon(&#39;list-add&#39;))

        self.main.setWindowIcon(icon(&quot;logo&quot;))

    # ----------------------------------------------------------------------
    def save_subprocess(self) -&gt; None:
        &quot;&quot;&quot;Save in a file all the child subprocess.&quot;&quot;&quot;
        current_process = psutil.Process()
        children = current_process.children(recursive=True)
        file = os.path.join(os.environ[&#39;BCISTREAM_HOME&#39;], &#39;.subprocess&#39;)
        try:
            with open(file, &#39;w&#39;) as file_:
                json.dump({ch.pid: ch.name()
                           for ch in children}, file_, indent=2)
        except:  # psutil.NoSuchProcess: psutil.NoSuchProcess process no longer exists
            pass

    # ----------------------------------------------------------------------
    def load_fonts(self) -&gt; None:
        &quot;&quot;&quot;Load custom fonts.&quot;&quot;&quot;
        fonts_path = os.path.join(
            os.environ[&#39;BCISTREAM_ROOT&#39;], &#39;assets&#39;, &#39;fonts&#39;)

        for font_dir in [os.path.join(&#39;dejavu&#39;, &#39;ttf&#39;)]:
            for font in filter(lambda s: s.endswith(&#39;.ttf&#39;), os.listdir(os.path.join(fonts_path, font_dir))):
                QFontDatabase.addApplicationFont(
                    os.path.join(fonts_path, font_dir, font))

    # ----------------------------------------------------------------------
    def build_collapse_button(self) -&gt; None:
        &quot;&quot;&quot;Custom collapsible widgets area.&quot;&quot;&quot;
        # This dockWidget has empy name so,
        # with in that space is possible to add a custom widget
        self.pushButton_collapse_dock = QPushButton(
            self.main.dockWidget_global)
        self.pushButton_collapse_dock.clicked.connect(
            self.set_dock_collapsed)

        icon = QIcon(&#39;bci:/primary/arrow-right-double.svg&#39;)
        self.pushButton_collapse_dock.setIcon(icon)
        self.pushButton_collapse_dock.setCheckable(True)
        self.pushButton_collapse_dock.setFlat(True)

        w = self.main.tabWidget_widgets.tabBar().width()
        self.pushButton_collapse_dock.setMinimumWidth(w)
        self.pushButton_collapse_dock.setMaximumWidth(w)
        self.pushButton_collapse_dock.move(5, 5)

    # ----------------------------------------------------------------------
    def set_dock_collapsed(self, collapsed: bool) -&gt; None:
        &quot;&quot;&quot;Collapse widgets area.&quot;&quot;&quot;
        if collapsed:
            w = self.main.tabWidget_widgets.tabBar().width() + 10
            icon = QIcon(&#39;bci:/primary/arrow-left-double.svg&#39;)
            self.previous_width = self.main.dockWidget_global.width()
        else:
            if self.main.dockWidget_global.width() &gt; 50:
                return
            icon = QIcon(&#39;bci:/primary/arrow-right-double.svg&#39;)
            w = self.previous_width

        self.pushButton_collapse_dock.setIcon(icon)
        self.main.dockWidget_global.setMaximumWidth(w)
        self.main.dockWidget_global.setMinimumWidth(w)

        if not collapsed:
            self.main.dockWidget_global.setMaximumWidth(9999)
            self.main.dockWidget_global.setMinimumWidth(100)

    # ----------------------------------------------------------------------
    def toggle_dock_collapsed(self) -&gt; None:
        &quot;&quot;&quot;&quot;&quot;&quot;
        if self.main.dockWidget_global.maximumWidth() &gt;= 9999:
            self.set_dock_collapsed(True)
        else:
            self.set_dock_collapsed(False)

    # ----------------------------------------------------------------------
    def connect(self) -&gt; None:
        &quot;&quot;&quot;Connect events.&quot;&quot;&quot;
        self.main.tabWidget_widgets.currentChanged.connect(
            lambda: self.set_dock_collapsed(False))

        self.main.pushButton_add_project_2.clicked.connect(
            self.projects.show_create_project_dialog)

        self.main.pushButton_show_visualization.clicked.connect(
            lambda evt: self.show_interface(&#39;Visualizations&#39;))
        self.main.pushButton_show_stimuli_delivery.clicked.connect(
            lambda evt: self.show_interface(&#39;Stimuli_delivery&#39;))

        self.main.pushButton_show_documentation.clicked.connect(
            lambda evt: self.show_interface(&#39;Documentation&#39;))

        self.main.pushButton_show_about.clicked.connect(self.show_about)
        self.main.pushButton_show_configurations.clicked.connect(
            self.show_configurations)

        self.main.pushButton_show_latency_correction.clicked.connect(
            lambda evt: self.show_interface(&#39;Stimuli_delivery&#39;, 1))

        self.main.pushButton_show_annotations.clicked.connect(
            lambda evt: self.main.tabWidget_widgets.setCurrentIndex(3))

        self.main.tabWidget_widgets.currentChanged.connect(self.show_widget)

    # ----------------------------------------------------------------------
    def show_interface(self, interface: str, sub_widget: Optional[int] = None) -&gt; None:
        &quot;&quot;&quot;Switch between environs.&quot;&quot;&quot;
        self.main.stackedWidget_modes.setCurrentWidget(
            getattr(self.main, f&quot;page{interface}&quot;))
        for action in self.main.toolBar_environs.actions():
            action.setChecked(False)
        for action in self.main.toolBar_Documentation.actions():
            action.setChecked(False)
        if action := getattr(self.main, f&quot;action{interface}&quot;, False):
            action.setChecked(True)

        if mod := getattr(self, f&#39;{interface.lower().replace(&quot; &quot;, &quot;_&quot;)}&#39;, False):
            if on_focus := getattr(mod, &#39;on_focus&#39;):
                on_focus()

        if sub_widget != None:
            if interface == &#39;Stimuli_delivery&#39;:
                self.main.tabWidget_stimuli_delivery.setCurrentIndex(sub_widget)

    # ----------------------------------------------------------------------
    def show_widget(self, index: int) -&gt; None:
        &quot;&quot;&quot;Call `on_focus` method for all widgets.&quot;&quot;&quot;
        widget = self.main.tabWidget_widgets.tabText(index)
        if wg := getattr(self, widget.lower(), False):
            if on_focus := getattr(wg, &#39;on_focus&#39;, False):
                on_focus()

    # ----------------------------------------------------------------------
    def set_editor(self) -&gt; None:
        &quot;&quot;&quot;Change some styles.&quot;&quot;&quot;
        self.main.plainTextEdit_preview_log.setStyleSheet(&quot;&quot;&quot;
        *{
        font-weight: normal;
        font-family: &#39;DejaVu Sans Mono&#39;;
        font-size: 13px;
        }
        &quot;&quot;&quot;)

        self.main.mdiArea.setStyleSheet(f&quot;&quot;&quot;
        *{{
        background: {os.environ.get(&#39;QTMATERIAL_SECONDARYDARKCOLOR&#39;)};
        }}
        &quot;&quot;&quot;)

    # # ----------------------------------------------------------------------
    # def remove_widgets_from_layout(self, layout) -&gt; None:
        # &quot;&quot;&quot;&quot;&quot;&quot;
        # for i in reversed(range(layout.count())):
            # if item := layout.takeAt(i):
                # item.widget().deleteLater()

    # ----------------------------------------------------------------------
    def status_bar(self, message: str = None, right_message: str = None) -&gt; None:
        &quot;&quot;&quot;Update messages for status bar.&quot;&quot;&quot;
        statusbar = self.main.statusBar()

        if not hasattr(statusbar, &#39;right_label&#39;):
            statusbar.right_label = QLabel(statusbar)
            statusbar.right_label.setAlignment(Qt.AlignRight)
            statusbar.right_label.mousePressEvent = lambda evt: self.main.tabWidget_widgets.setCurrentWidget(
                self.main.tab_connection)
            statusbar.addPermanentWidget(statusbar.right_label)

            statusbar.btn = QPushButton()
            statusbar.btn.setProperty(&#39;class&#39;, &#39;connection&#39;)
            statusbar.btn.blockSignals(True)
            statusbar.addPermanentWidget(statusbar.btn)

        if message:
            statusbar.showMessage(message)

        if right_message:
            # statusbar.btn.blockSignals(False)
            message, status = right_message
            statusbar.right_label.setText(message)
            if status is None:
                statusbar.btn.setDisabled(True)
                if &#39;light&#39; in os.environ.get(&#39;QTMATERIAL_THEME&#39;):
                    statusbar.btn.setStyleSheet(f&quot;&quot;&quot;*{{
                    border: 1px solid {os.environ.get(&#39;QTMATERIAL_SECONDARYDARKCOLOR&#39;)};
                    background-color: {os.environ.get(&#39;QTMATERIAL_SECONDARYDARKCOLOR&#39;)};}}&quot;&quot;&quot;)
                else:
                    statusbar.btn.setStyleSheet(f&quot;&quot;&quot;*{{
                    border: 1px solid {os.environ.get(&#39;QTMATERIAL_SECONDARYLIGHTCOLOR&#39;)};
                    background-color: {os.environ.get(&#39;QTMATERIAL_SECONDARYLIGHTCOLOR&#39;)};}}&quot;&quot;&quot;)
            else:
                statusbar.btn.setDisabled(False)
                if status:
                    statusbar.btn.setStyleSheet(&quot;&quot;&quot;*{
                      border: 1px solid #3fc55e;
                    background-color: #3fc55e;}&quot;&quot;&quot;)
                else:
                    statusbar.btn.setStyleSheet(&quot;&quot;&quot;*{
                      border: 1px solid #dc3545;
                    background-color: #dc3545;}&quot;&quot;&quot;)

    # ----------------------------------------------------------------------
    def style_home_page(self) -&gt; None:
        &quot;&quot;&quot;Set the styles for home page.&quot;&quot;&quot;
        style = f&quot;&quot;&quot;
        *{{
        width:      80px;
        height:     80px;
        max-width:  80px;
        min-width:  80px;
        max-height: 80px;
        min-height: 80px;
        background-color: {os.environ.get(&#39;secondaryColor&#39;)}
        }}
        &quot;&quot;&quot;
        self.main.pushButton_file.setStyleSheet(style)
        self.main.pushButton_brain.setStyleSheet(style)
        self.main.pushButton_imagery.setStyleSheet(style)
        self.main.pushButton_docs.setStyleSheet(style)
        self.main.pushButton_latency.setStyleSheet(style)
        self.main.pushButton_annotations.setStyleSheet(style)

        style = f&quot;&quot;&quot;
        QFrame {{
        background-color: {os.environ.get(&#39;secondaryColor&#39;)}
        }}
        &quot;&quot;&quot;
        self.main.frame_3.setStyleSheet(style)
        self.main.frame_2.setStyleSheet(style)
        self.main.frame_5.setStyleSheet(style)
        self.main.frame_6.setStyleSheet(style)
        self.main.frame_7.setStyleSheet(style)
        self.main.frame.setStyleSheet(style)

        style = &quot;&quot;&quot;
        *{
        font-family: &quot;Roboto Light&quot;;
        font-weight: 300;
        }
        &quot;&quot;&quot;

        self.main.label_15.setStyleSheet(style)
        self.main.label_16.setStyleSheet(style)
        self.main.label_17.setStyleSheet(style)
        self.main.label_20.setStyleSheet(style)
        self.main.label_21.setStyleSheet(style)
        self.main.label_22.setStyleSheet(style)

    # ----------------------------------------------------------------------
    def show_about(self, event=None) -&gt; None:
        &quot;&quot;&quot;Display about window.&quot;&quot;&quot;
        frame = os.path.join(
            os.environ[&#39;BCISTREAM_ROOT&#39;], &#39;framework&#39;, &#39;qtgui&#39;, &#39;about.ui&#39;)
        about = QUiLoader().load(frame, self.main)
        about.label.setScaledContents(True)

        about.pushButton_close.clicked.connect(
            lambda evt: about.destroy())

        about.label.setMinimumSize(QSize(720, 200))
        about.label.setMaximumSize(QSize(720, 200))

        banner = os.path.join(
            os.environ[&#39;BCISTREAM_ROOT&#39;], &#39;assets&#39;, &#39;banner.png&#39;)
        about.label.setPixmap(QPixmap(banner))

        about.tabWidget.setCurrentIndex(0)

        about.setStyleSheet(f&quot;&quot;&quot;
        QPlainTextEdit {{
        font-weight: normal;
        font-family: &#39;DejaVu Sans Mono&#39;;
        font-size: 13px;
        }}

        QTextEdit {{
        color: {os.environ.get(&#39;QTMATERIAL_SECONDARYTEXTCOLOR&#39;)};
        }}
        &quot;&quot;&quot;)

        center = QDesktopWidget().availableGeometry().center()
        geometry = about.frameGeometry()
        geometry.moveCenter(center)
        about.move(geometry.topLeft())

        about.show()

    # ----------------------------------------------------------------------
    @Slot()
    def on_kafka_event(self, value: KAFKA_STREAM) -&gt; None:
        &quot;&quot;&quot;Register annotations and markers.&quot;&quot;&quot;
        # self.main.pushButton_connect.setChecked(True)
        # self.main.pushButton_connect.setText(&#39;Disconnect&#39;)
        self.streaming = True

        if value[&#39;topic&#39;] == &#39;marker&#39;:
            self.annotations.add_marker(datetime.fromtimestamp(
                value[&#39;value&#39;][&#39;timestamp&#39;]), value[&#39;value&#39;][&#39;marker&#39;])
        elif value[&#39;topic&#39;] == &#39;command&#39;:
            self.annotations.add_command(datetime.fromtimestamp(
                value[&#39;value&#39;][&#39;timestamp&#39;]), value[&#39;value&#39;][&#39;command&#39;])
        elif value[&#39;topic&#39;] == &#39;annotation&#39;:
            self.annotations.add_annotation(datetime.fromtimestamp(value[&#39;value&#39;][&#39;timestamp&#39;]),
                                            value[&#39;value&#39;][&#39;duration&#39;],
                                            value[&#39;value&#39;][&#39;description&#39;])
        elif value[&#39;topic&#39;] == &#39;feedback&#39;:
            self.handle_feedback(value[&#39;value&#39;])

        elif value[&#39;topic&#39;] == &#39;eeg&#39;:
            # self.status_bar(&#39;Incoming streaming detected&#39;)
            eeg, aux = value[&#39;value&#39;][&#39;data&#39;]
            binary_created = datetime.fromtimestamp(
                value[&#39;value&#39;][&#39;context&#39;][&#39;binary_created&#39;])
            message_created = datetime.fromtimestamp(
                value[&#39;value&#39;][&#39;timestamp&#39;])
            # since = (datetime.now() - binary_created).total_seconds()
            since = (message_created - binary_created).total_seconds()
            count = value[&#39;value&#39;][&#39;context&#39;][&#39;samples&#39;]
            channels = eeg.shape[0]

            if since * 1000 &gt; 2000:
                color = &#39;#ffc107&#39;  # old data
            else:
                color = &#39;#3fc55e&#39;  # recent data

            message = f&#39;Last package streamed &lt;b style=&quot;color:{color};&quot;&gt;{since*1000:0.2f} ms &lt;/b&gt; ago | EEG ({channels},{count})&#39;

            if aux.size:
                message += f&#39; | AUX ({aux.shape[0]},{aux.shape[1]})&#39;

            self.status_bar(right_message=(message, True))

    # ----------------------------------------------------------------------
    def update_kafka(self, host) -&gt; None:
        &quot;&quot;&quot;Try to restart kafka services.&quot;&quot;&quot;
        if hasattr(self, &#39;thread_kafka&#39;):
            self.thread_kafka.stop()
            self.status_bar(right_message=(&#39;No streaming&#39;, False))
        # try:
        self.thread_kafka = Kafka()
        self.thread_kafka.over.connect(self.on_kafka_event)
        self.thread_kafka.message.connect(self.kafka_message)
        self.thread_kafka.produser_connected.connect(
            self.kafka_produser_connected)
        self.thread_kafka.set_host(host)
        self.thread_kafka.start()

        self.timer = QTimer()
        self.timer.setInterval(5000)
        self.timer.timeout.connect(self.keep_updated)
        self.timer.start()

    # ----------------------------------------------------------------------
    def stop_kafka(self) -&gt; None:
        &quot;&quot;&quot;Stop kafka.&quot;&quot;&quot;
        self.streaming = False
        if hasattr(self, &#39;thread_kafka&#39;):
            self.thread_kafka.stop()
            self.status_bar(right_message=(&#39;No streaming&#39;, False))

    # ----------------------------------------------------------------------
    def keep_updated(self) -&gt; None:
        &quot;&quot;&quot;The status is update each 3 seconds.&quot;&quot;&quot;
        if hasattr(self, &#39;thread_kafka&#39;) and hasattr(self.thread_kafka, &#39;last_message&#39;):
            last = datetime.now() - self.thread_kafka.last_message
            if last.seconds &gt; 3:
                self.status_bar(right_message=(&#39;No streaming&#39;, False))
                self.annotations.set_enable(False)
                self.main.pushButton_record.setEnabled(False)
                self.streaming = False
            else:
                self.annotations.set_enable(True)
                self.main.pushButton_record.setEnabled(True)

    # ----------------------------------------------------------------------
    @Slot()
    def kafka_message(self) -&gt; None:
        &quot;&quot;&quot;Error on kafka.&quot;&quot;&quot;
        self.streaming = False
        if self.main.comboBox_host.currentText() != &#39;localhost&#39;:
            self.conection_message = f&#39;* Imposible to connect with remote Kafka on &quot;{self.main.comboBox_host.currentText()}&quot;.&#39;
        else:
            self.conection_message = &#39;* Kafka is not running on this machine.&#39;

        self.status_bar(right_message=(&#39;Disconnected&#39;, None))

    # ----------------------------------------------------------------------
    @Slot()
    def kafka_produser_connected(self) -&gt; None:
        &quot;&quot;&quot;If produser connected is posible the consumer too.&quot;&quot;&quot;
        self.status_bar(right_message=(&#39;Connected&#39;, False))

    # ----------------------------------------------------------------------
    def show_configurations(self, *args, **kwargs) -&gt; None:
        &quot;&quot;&quot;Show configuration window.&quot;&quot;&quot;
        configuration = ConfigurationFrame(self)
        configuration.show()

    # ----------------------------------------------------------------------
    def handle_feedback(self, data):
        &quot;&quot;&quot;&quot;&quot;&quot;
        if fn := getattr(self, f&quot;feedback_{data[&#39;name&#39;]}&quot;, False):
            fn(data[&#39;value&#39;])

    # ----------------------------------------------------------------------
    def feedback_set_latency(self, value):
        &quot;&quot;&quot;&quot;&quot;&quot;
        os.environ[&#39;BCISTREAM_SYNCLATENCY&#39;] = json.dumps(value)

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/logo.svg" alt="Logo"/>
            </a></p><h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/00-installation.html">Installation and running</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/01-configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/02-interface.html">Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/70-data_analysis.html">Data analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/75-data_visualizations.html">Data visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/76-default_visualizations.html">Examples of data visualizations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/80-stimuli_delivery.html">Stimuli delivery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/81-default_stimuli_delivery_paradigms.html">Examples of stimuli delivery paradigms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/90-event_marker_synchronization.html">Event marker synchronization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/91-eeg_records_exploring.html">EEG records exploring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/99-ilustrative_example.html">Illustrative example</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, Yeison Cardona.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.5.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>